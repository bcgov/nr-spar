<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OracleApiProvider.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">nr-spar-backend</a> &gt; <a href="index.source.html" class="el_package">ca.bc.gov.backendstartapi.provider</a> &gt; <span class="el_source">OracleApiProvider.java</span></div><h1>OracleApiProvider.java</h1><pre class="source lang-java linenums">package ca.bc.gov.backendstartapi.provider;

import ca.bc.gov.backendstartapi.config.ProvidersConfig;
import ca.bc.gov.backendstartapi.config.SparLog;
import ca.bc.gov.backendstartapi.dto.OrchardDto;
import ca.bc.gov.backendstartapi.dto.OrchardSpuDto;
import ca.bc.gov.backendstartapi.dto.ParentTreeDto;
import ca.bc.gov.backendstartapi.dto.ParentTreeLocInfoDto;
import ca.bc.gov.backendstartapi.dto.SameSpeciesTreeDto;
import ca.bc.gov.backendstartapi.dto.SeedPlanZoneDto;
import ca.bc.gov.backendstartapi.filter.RequestCorrelation;
import ca.bc.gov.backendstartapi.security.LoggedUserService;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.boot.web.client.RestTemplateBuilder;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Component;
import org.springframework.web.client.HttpClientErrorException;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.server.ResponseStatusException;

/** This class contains methods for fetching data from Oracle REST API. */
@Component
@Qualifier(&quot;oracleApi&quot;)
public class OracleApiProvider implements Provider {

  private final LoggedUserService loggedUserService;

  private final ProvidersConfig providersConfig;

  private final RestTemplate restTemplate;

  private final String rootUri;

  private static final String PROVIDER = &quot;Oracle API&quot;;

  OracleApiProvider(
      LoggedUserService loggedUserService,
      ProvidersConfig providersConfig,
<span class="fc" id="L47">      RestTemplateBuilder templateBuilder) {</span>
<span class="fc" id="L48">    this.loggedUserService = loggedUserService;</span>
<span class="fc" id="L49">    this.providersConfig = providersConfig;</span>
<span class="fc" id="L50">    this.restTemplate = templateBuilder.build();</span>
<span class="fc" id="L51">    this.rootUri = this.providersConfig.getOracleApiBaseUri();</span>
<span class="fc" id="L52">  }</span>

  /**
   * Find all Parent Tree and Genetic Quality to an Orchard.
   *
   * @param orchardId Orchard's identification.
   * @param spuId SPU's identification.
   * @return An {@link Optional} of {@link OrchardSpuDto}
   */
  @Override
  public Optional&lt;OrchardSpuDto&gt; findOrchardParentTreeGeneticQualityData(
      String orchardId, int spuId) {
<span class="fc" id="L64">    String apiUrl =</span>
<span class="fc" id="L65">        String.format(&quot;%s/api/orchards/parent-tree-genetic-quality/{orchardId}/{spuId}&quot;, rootUri);</span>

<span class="fc" id="L67">    SparLog.info(&quot;Starting {} request to {}&quot;, PROVIDER, apiUrl);</span>

    try {
<span class="fc" id="L70">      ResponseEntity&lt;OrchardSpuDto&gt; response =</span>
<span class="fc" id="L71">          restTemplate.exchange(</span>
              apiUrl,
              HttpMethod.GET,
<span class="fc" id="L74">              new HttpEntity&lt;&gt;(addHttpHeaders()),</span>
              OrchardSpuDto.class,
<span class="fc" id="L76">              createParamsMap(&quot;orchardId&quot;, orchardId, &quot;spuId&quot;, String.valueOf(spuId)));</span>

<span class="fc" id="L78">      SparLog.info(&quot;Finished {} request - 200 OK!&quot;, PROVIDER);</span>
<span class="fc" id="L79">      return Optional.of(response.getBody());</span>
<span class="fc" id="L80">    } catch (HttpClientErrorException httpExc) {</span>
<span class="fc" id="L81">      SparLog.error(</span>
<span class="fc" id="L82">          &quot;Finished {} request - Response code error: {}&quot;, PROVIDER, httpExc.getStatusCode());</span>
    }

<span class="fc" id="L85">    return Optional.empty();</span>
  }

  /**
   * Finds all orchards with the provided vegCode from oracle-api.
   *
   * @param vegCode The vegetation code of a seedlot.
   * @return An {@link List} of {@link OrchardDto}
   */
  @Override
  public List&lt;OrchardDto&gt; findOrchardsByVegCode(String vegCode) {
<span class="fc" id="L96">    String oracleApiUrl = String.format(&quot;%s/api/orchards/vegetation-code/{vegCode}&quot;, rootUri);</span>

<span class="fc" id="L98">    SparLog.info(&quot;Starting {} - {} request to {}&quot;, PROVIDER, &quot;findOrchardsByVegCode&quot;, oracleApiUrl);</span>

    try {
<span class="fc" id="L101">      ResponseEntity&lt;List&lt;OrchardDto&gt;&gt; orchardsResult =</span>
<span class="fc" id="L102">          restTemplate.exchange(</span>
              oracleApiUrl,
              HttpMethod.GET,
<span class="fc" id="L105">              new HttpEntity&lt;&gt;(addHttpHeaders()),</span>
<span class="fc" id="L106">              new ParameterizedTypeReference&lt;List&lt;OrchardDto&gt;&gt;() {},</span>
<span class="fc" id="L107">              createParamsMap(&quot;vegCode&quot;, vegCode));</span>
<span class="fc" id="L108">      SparLog.info(&quot;GET orchards by vegCode from oracle - Success response!&quot;);</span>
<span class="fc" id="L109">      return orchardsResult.getBody();</span>
<span class="fc" id="L110">    } catch (HttpClientErrorException httpExc) {</span>
<span class="fc" id="L111">      SparLog.error(</span>
<span class="fc" id="L112">          &quot;GET orchards by vegCode from oracle - Response code error: {}&quot;, httpExc.getStatusCode());</span>
    }

<span class="fc" id="L115">    return List.of();</span>
  }

  /**
   * Finds all orchards with the provided vegCode from oracle-api.
   *
   * @param vegCode The vegetation code of a seedlot.
   * @return An {@link List} of {@link ParentTreeDto}
   */
  @Override
  public List&lt;SameSpeciesTreeDto&gt; findParentTreesByVegCode(
      String vegCode, Map&lt;String, String&gt; orchardSpuMap) {
<span class="fc" id="L127">    String oracleApiUrl =</span>
<span class="fc" id="L128">        String.format(&quot;%s/api/orchards/parent-trees/vegetation-codes/{vegCode}&quot;, rootUri);</span>

<span class="fc" id="L130">    SparLog.info(</span>
        &quot;Starting {} - {} request to {}&quot;, PROVIDER, &quot;findParentTreesByVegCode&quot;, oracleApiUrl);

<span class="fc" id="L133">    HttpEntity&lt;Map&lt;String, String&gt;&gt; requestEntity =</span>
<span class="fc" id="L134">        new HttpEntity&lt;&gt;(orchardSpuMap, addHttpHeaders());</span>

    try {
<span class="fc" id="L137">      ResponseEntity&lt;List&lt;SameSpeciesTreeDto&gt;&gt; parentTreesResult =</span>
<span class="fc" id="L138">          restTemplate.exchange(</span>
              oracleApiUrl,
              HttpMethod.POST,
              requestEntity,
<span class="fc" id="L142">              new ParameterizedTypeReference&lt;List&lt;SameSpeciesTreeDto&gt;&gt;() {},</span>
<span class="fc" id="L143">              createParamsMap(&quot;vegCode&quot;, vegCode));</span>
<span class="fc" id="L144">      List&lt;SameSpeciesTreeDto&gt; list = parentTreesResult.getBody();</span>
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">      int size = list == null ? 0 : list.size();</span>
<span class="fc" id="L146">      SparLog.info(</span>
          &quot;POST spu to oracle to get parent trees with vegCode - Success response with size: {}!&quot;,
<span class="fc" id="L148">          size);</span>
<span class="fc" id="L149">      return list;</span>
<span class="fc" id="L150">    } catch (HttpClientErrorException httpExc) {</span>
<span class="fc" id="L151">      SparLog.error(</span>
          &quot;POST spu to oracle to get parent trees with vegCode - Response code error: {}, {}&quot;,
<span class="fc" id="L153">          httpExc.getStatusCode(),</span>
<span class="fc" id="L154">          httpExc.getMessage());</span>
<span class="fc" id="L155">      throw new ResponseStatusException(httpExc.getStatusCode(), httpExc.getMessage());</span>
    }
  }

  @Override
  public List&lt;SeedPlanZoneDto&gt; getSpzInformationBySpuIds(List&lt;Integer&gt; spuIds) {
<span class="nc" id="L161">    String oracleApiUrl =</span>
<span class="nc" id="L162">        String.format(&quot;%s/api/orchards/spz-information-by-spu-ids/{spuIds}&quot;, rootUri);</span>

<span class="nc" id="L164">    SparLog.info(</span>
        &quot;Starting {} - {} request to {}&quot;, PROVIDER, &quot;getSpzInformationBySpuIds&quot;, oracleApiUrl);

    try {
<span class="nc" id="L168">      StringBuilder sb = new StringBuilder();</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">      for (Integer id : spuIds) {</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (!sb.isEmpty()) {</span>
<span class="nc" id="L171">          sb.append(&quot;,&quot;);</span>
        }
<span class="nc" id="L173">        sb.append(id);</span>
<span class="nc" id="L174">      }</span>

<span class="nc" id="L176">      ResponseEntity&lt;List&lt;SeedPlanZoneDto&gt;&gt; seedPlanZoneResult =</span>
<span class="nc" id="L177">          restTemplate.exchange(</span>
              oracleApiUrl,
              HttpMethod.GET,
<span class="nc" id="L180">              new HttpEntity&lt;&gt;(addHttpHeaders()),</span>
<span class="nc" id="L181">              new ParameterizedTypeReference&lt;List&lt;SeedPlanZoneDto&gt;&gt;() {},</span>
<span class="nc" id="L182">              createParamsMap(&quot;spuIds&quot;, sb.toString()));</span>
<span class="nc" id="L183">      List&lt;SeedPlanZoneDto&gt; list = seedPlanZoneResult.getBody();</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">      int size = list == null ? 0 : list.size();</span>
<span class="nc" id="L185">      SparLog.info(&quot;GET SPZ from Oracle - Success response with {} record(s)!&quot;, size);</span>
<span class="nc" id="L186">      return list;</span>
<span class="nc" id="L187">    } catch (HttpClientErrorException httpExc) {</span>
<span class="nc" id="L188">      SparLog.error(</span>
          &quot;GET SPZ from Oracle - Response code error: {}, {}&quot;,
<span class="nc" id="L190">          httpExc.getStatusCode(),</span>
<span class="nc" id="L191">          httpExc.getMessage());</span>
<span class="nc" id="L192">      throw new ResponseStatusException(httpExc.getStatusCode(), httpExc.getMessage());</span>
    }
  }

  @Override
  public List&lt;ParentTreeLocInfoDto&gt; getParentTreeLatLongByIdList(List&lt;Integer&gt; ptIds) {
<span class="nc" id="L198">    String oracleApiUrl = String.format(&quot;%s/api/parent-trees/geospatial-data&quot;, rootUri);</span>

<span class="nc" id="L200">    SparLog.info(</span>
        &quot;Starting {} - {} request to {}&quot;, PROVIDER, &quot;getParentTreeLatLongByIdList&quot;, oracleApiUrl);

    try {
<span class="nc" id="L204">      StringBuilder sb = new StringBuilder(&quot;[&quot;);</span>
<span class="nc" id="L205">      ptIds.forEach(</span>
          (id) -&gt; {
<span class="nc bnc" id="L207" title="All 2 branches missed.">            if (ptIds.indexOf(id) &gt; 0) {</span>
<span class="nc" id="L208">              sb.append(&quot;,&quot;);</span>
            }
<span class="nc" id="L210">            sb.append(&quot;{&quot;).append(&quot;\&quot;parentTreeId\&quot;:&quot;).append(id).append(&quot;}&quot;);</span>
<span class="nc" id="L211">          });</span>
<span class="nc" id="L212">      sb.append(&quot;]&quot;);</span>
<span class="nc" id="L213">      HttpEntity&lt;String&gt; requestEntity = new HttpEntity&lt;&gt;(sb.toString(), addHttpHeaders());</span>

<span class="nc" id="L215">      ResponseEntity&lt;List&lt;ParentTreeLocInfoDto&gt;&gt; ptreeResponse =</span>
<span class="nc" id="L216">          restTemplate.exchange(</span>
              oracleApiUrl,
              HttpMethod.POST,
              requestEntity,
<span class="nc" id="L220">              new ParameterizedTypeReference&lt;List&lt;ParentTreeLocInfoDto&gt;&gt;() {});</span>

<span class="nc" id="L222">      List&lt;ParentTreeLocInfoDto&gt; list = ptreeResponse.getBody();</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">      int size = list == null ? 0 : list.size();</span>
<span class="nc" id="L224">      SparLog.info(</span>
<span class="nc" id="L225">          &quot;GET parent tree lat long from Oracle - Success response with {} record(s)!&quot;, size);</span>
<span class="nc" id="L226">      return list;</span>
<span class="nc" id="L227">    } catch (HttpClientErrorException httpExc) {</span>
<span class="nc" id="L228">      SparLog.error(</span>
          &quot;GET parent tree lat long from Oracle - Response code error: {}, {}&quot;,
<span class="nc" id="L230">          httpExc.getStatusCode(),</span>
<span class="nc" id="L231">          httpExc.getMessage());</span>
<span class="nc" id="L232">      throw new ResponseStatusException(httpExc.getStatusCode(), httpExc.getMessage());</span>
    }
  }

  @Override
  public String[] addAuthorizationHeader() {
<span class="fc" id="L238">    String token = this.loggedUserService.getLoggedUserToken();</span>
<span class="fc" id="L239">    return new String[] {&quot;Authorization&quot;, &quot;Bearer &quot; + token};</span>
  }

  @Override
  public HttpHeaders addHttpHeaders() {
<span class="fc" id="L244">    HttpHeaders headers = new HttpHeaders();</span>
<span class="fc" id="L245">    headers.set(&quot;Content-Type&quot;, MediaType.APPLICATION_JSON_VALUE);</span>

<span class="fc" id="L247">    String[] authorization = addAuthorizationHeader();</span>
<span class="fc" id="L248">    headers.set(authorization[0], authorization[1]);</span>

    // For distributed log tracing
<span class="fc" id="L251">    String correlationId = RequestCorrelation.getId();</span>
<span class="fc" id="L252">    headers.set(RequestCorrelation.CORRELATION_ID_HEADER, correlationId);</span>

<span class="fc" id="L254">    return headers;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>