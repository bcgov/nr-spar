<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ForestClientApiProvider.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">nr-spar-backend</a> &gt; <a href="index.source.html" class="el_package">ca.bc.gov.backendstartapi.provider</a> &gt; <span class="el_source">ForestClientApiProvider.java</span></div><h1>ForestClientApiProvider.java</h1><pre class="source lang-java linenums">package ca.bc.gov.backendstartapi.provider;

import ca.bc.gov.backendstartapi.config.ProvidersConfig;
import ca.bc.gov.backendstartapi.config.SparLog;
import ca.bc.gov.backendstartapi.dto.ForestClientDto;
import ca.bc.gov.backendstartapi.dto.ForestClientLocationDto;
import ca.bc.gov.backendstartapi.enums.ForestClientExpiredEnum;
import ca.bc.gov.backendstartapi.enums.ForestClientStatusEnum;
import ca.bc.gov.backendstartapi.enums.ForestClientTypeEnum;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Optional;
import java.util.function.Predicate;
import java.util.regex.Pattern;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.boot.web.client.RestTemplateBuilder;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.core.env.Environment;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Component;
import org.springframework.web.client.HttpClientErrorException;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.server.ResponseStatusException;
import org.springframework.web.util.UriComponentsBuilder;

/** Makes HTTP requests to the Forest Client API server. */
@Component
@Qualifier(&quot;forestClientApi&quot;)
public class ForestClientApiProvider implements Provider {

<span class="fc" id="L37">  private static final Predicate&lt;String&gt; numberPredicate =</span>
<span class="fc" id="L38">      Pattern.compile(&quot;^\\d{8}$&quot;).asMatchPredicate();</span>

  private final ProvidersConfig providersConfig;

  private final RestTemplate restTemplate;

  private final String rootUri;

  private static final String PROVIDER = &quot;ForestClient API&quot;;

  @Autowired private Environment environment;

<span class="fc" id="L50">  ForestClientApiProvider(ProvidersConfig providersConfig, RestTemplateBuilder templateBuilder) {</span>
<span class="fc" id="L51">    this.providersConfig = providersConfig;</span>
<span class="fc" id="L52">    this.restTemplate = templateBuilder.build();</span>
<span class="fc" id="L53">    this.rootUri = this.providersConfig.getForestClientBaseUri();</span>
<span class="fc" id="L54">  }</span>

  /**
   * Fetch a ForestClient by its number or its acronym.
   *
   * @param identifier the client number or acronym to search for
   * @return the ForestClient with client number or acronym {@code identifier}, if one exists
   */
  @Override
  public Optional&lt;ForestClientDto&gt; fetchClientByIdentifier(String identifier) {
<span class="fc bfc" id="L64" title="All 2 branches covered.">    if (numberPredicate.test(identifier)) {</span>
<span class="fc" id="L65">      return fetchClientByNumber(identifier);</span>
    }

<span class="fc" id="L68">    return fetchClientByAcronym(identifier);</span>
  }

  private Optional&lt;ForestClientDto&gt; fetchClientByNumber(String number) {
<span class="fc" id="L72">    String apiUrl = String.format(&quot;%s/clients/findByClientNumber/{number}&quot;, rootUri);</span>
<span class="fc" id="L73">    SparLog.info(&quot;Starting {} request to {}&quot;, PROVIDER, apiUrl);</span>

<span class="pc bpc" id="L75" title="1 of 2 branches missed.">    if (shouldMock()) {</span>
<span class="nc" id="L76">      return Optional.of(mockForestClientDto(number));</span>
    }

    try {
<span class="fc" id="L80">      ResponseEntity&lt;ForestClientDto&gt; response =</span>
<span class="fc" id="L81">          restTemplate.exchange(</span>
              apiUrl,
              HttpMethod.GET,
<span class="fc" id="L84">              new HttpEntity&lt;&gt;(addHttpHeaders()),</span>
              ForestClientDto.class,
<span class="fc" id="L86">              createParamsMap(&quot;number&quot;, number));</span>

<span class="fc" id="L88">      SparLog.info(</span>
          &quot;Finished {} request for function {} - 200 OK!&quot;, PROVIDER, &quot;fetchClientByNumber&quot;);
<span class="fc" id="L90">      return Optional.of(response.getBody());</span>
<span class="fc" id="L91">    } catch (HttpClientErrorException httpExc) {</span>
<span class="fc" id="L92">      SparLog.error(</span>
<span class="fc" id="L93">          &quot;Finished {} request - Response code error: {}&quot;, PROVIDER, httpExc.getStatusCode());</span>
    }

<span class="fc" id="L96">    return Optional.empty();</span>
  }

  private Optional&lt;ForestClientDto&gt; fetchClientByAcronym(String acronym) {
<span class="fc" id="L100">    String apiUrl = String.format(&quot;%s/clients/findByAcronym?acronym={acronym}&quot;, rootUri);</span>
<span class="fc" id="L101">    SparLog.info(&quot;Starting {} request to {}&quot;, PROVIDER, apiUrl);</span>

<span class="pc bpc" id="L103" title="1 of 2 branches missed.">    if (shouldMock()) {</span>
<span class="nc" id="L104">      return Optional.of(mockForestClientDto(acronym));</span>
    }

    try {
<span class="fc" id="L108">      ResponseEntity&lt;List&lt;ForestClientDto&gt;&gt; response =</span>
<span class="fc" id="L109">          restTemplate.exchange(</span>
              apiUrl,
              HttpMethod.GET,
<span class="fc" id="L112">              new HttpEntity&lt;&gt;(addHttpHeaders()),</span>
<span class="fc" id="L113">              new ParameterizedTypeReference&lt;List&lt;ForestClientDto&gt;&gt;() {},</span>
<span class="fc" id="L114">              createParamsMap(&quot;acronym&quot;, acronym.toUpperCase()));</span>

<span class="fc" id="L116">      List&lt;ForestClientDto&gt; dtoList = response.getBody();</span>

<span class="pc bpc" id="L118" title="1 of 2 branches missed.">      if (dtoList == null) {</span>
<span class="nc" id="L119">        return Optional.empty();</span>
      }

<span class="pc bpc" id="L122" title="1 of 2 branches missed.">      if (dtoList.size() &gt; 1) {</span>
<span class="nc" id="L123">        SparLog.warn(&quot;More than one client found for acronym {}&quot;, acronym);</span>
      }

<span class="fc" id="L126">      SparLog.info(</span>
          &quot;Finished {} request for function {} - 200 OK!&quot;, PROVIDER, &quot;fetchClientByAcronym&quot;);
<span class="fc" id="L128">      return dtoList.stream().findFirst();</span>
<span class="fc" id="L129">    } catch (HttpClientErrorException httpExc) {</span>
<span class="fc" id="L130">      SparLog.error(</span>
<span class="fc" id="L131">          &quot;Finished {} request - Response code error: {}&quot;, PROVIDER, httpExc.getStatusCode());</span>
    }

<span class="fc" id="L134">    return Optional.empty();</span>
  }

  /**
   * Fetch the 10 first ForestClient's location by its number if shouldFetchAll is false, fetch the
   * all matching records if shouldFetchAll is true.
   *
   * @param clientNumber the ForestClient identifier to fetch their locations
   * @param shouldFetchAll specifies if all records should be fetched for the given client number
   * @return a list of {@link ForestClientLocationDto} containing the client's locations data
   */
  @Override
  public List&lt;ForestClientLocationDto&gt; fetchLocationsByClientNumber(
      String clientNumber, Boolean shouldFetchAll) {
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">    if (shouldMock()) {</span>
<span class="nc" id="L149">      return List.of(mockForestClientLocationDto(clientNumber, &quot;99&quot;));</span>
    }

<span class="fc" id="L152">    int page = 0;</span>
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">    int size = shouldFetchAll ? 50 : 10;</span>
<span class="fc" id="L154">    int totalFetched = 0;</span>
<span class="fc" id="L155">    int totalCount = Integer.MAX_VALUE;</span>
<span class="fc" id="L156">    List&lt;ForestClientLocationDto&gt; result = new ArrayList&lt;&gt;();</span>

<span class="pc bpc" id="L158" title="1 of 2 branches missed.">    while (totalFetched &lt; totalCount) {</span>
      try {
<span class="fc" id="L160">        String apiUrl =</span>
<span class="fc" id="L161">            String.format(</span>
<span class="fc" id="L162">                &quot;%s/clients/{clientNumber}/locations?page=%s&amp;size=%s&quot;, rootUri, page, size);</span>
<span class="fc" id="L163">        SparLog.info(&quot;Starting {} request to {} for page {}&quot;, PROVIDER, apiUrl, page);</span>

<span class="fc" id="L165">        ResponseEntity&lt;List&lt;ForestClientLocationDto&gt;&gt; response =</span>
<span class="fc" id="L166">            restTemplate.exchange(</span>
                apiUrl,
                HttpMethod.GET,
<span class="fc" id="L169">                new HttpEntity&lt;&gt;(addHttpHeaders()),</span>
<span class="fc" id="L170">                new ParameterizedTypeReference&lt;List&lt;ForestClientLocationDto&gt;&gt;() {},</span>
<span class="fc" id="L171">                createParamsMap(&quot;clientNumber&quot;, clientNumber));</span>

<span class="fc" id="L173">        SparLog.info(</span>
            &quot;Finished {} request for function {} for page {} - 200 OK!&quot;,
            PROVIDER,
            &quot;fetchLocationsByClientNumber&quot;,
<span class="fc" id="L177">            page);</span>

<span class="fc" id="L179">        int responseSize = response.getBody().size();</span>

<span class="pc bpc" id="L181" title="3 of 4 branches missed.">        if (!shouldFetchAll || responseSize == 0) {</span>
<span class="fc" id="L182">          return response.getBody();</span>
        }

<span class="nc" id="L185">        totalCount = Integer.parseInt(response.getHeaders().get(&quot;x-total-count&quot;).get(0));</span>

<span class="nc" id="L187">        totalFetched += responseSize;</span>

<span class="nc" id="L189">        page += 1;</span>

<span class="nc" id="L191">        result.addAll(response.getBody());</span>
<span class="nc" id="L192">      } catch (HttpClientErrorException httpExc) {</span>
<span class="nc" id="L193">        SparLog.error(</span>
<span class="nc" id="L194">            &quot;Finished {} request - Response code error: {}&quot;, PROVIDER, httpExc.getStatusCode());</span>
<span class="nc" id="L195">        throw new ResponseStatusException(httpExc.getStatusCode(), httpExc.getMessage());</span>
<span class="nc" id="L196">      }</span>
    }

<span class="nc" id="L199">    SparLog.info(&quot;Fetched {} location records for client number {}&quot;, result.size(), clientNumber);</span>

<span class="nc" id="L201">    return result;</span>
  }

  /**
   * Fetch a single location of a ForestClient its number and location code.
   *
   * @param clientNumber the ForestClient identifier to fetch their location
   * @param locationCode the location code that identifies the location to be fetched
   * @return {@link ForestClientLocationDto} containing the client's location data
   */
  @Override
  public ForestClientLocationDto fetchSingleClientLocation(
      String clientNumber, String locationCode) {
<span class="fc" id="L214">    String apiUrl = String.format(&quot;%s/clients/{clientNumber}/locations/{locationCode}&quot;, rootUri);</span>
<span class="fc" id="L215">    SparLog.info(&quot;Starting {} request to {}&quot;, PROVIDER, apiUrl);</span>

<span class="pc bpc" id="L217" title="1 of 2 branches missed.">    if (shouldMock()) {</span>
<span class="nc" id="L218">      return mockForestClientLocationDto(clientNumber, locationCode);</span>
    }

    try {
<span class="fc" id="L222">      ResponseEntity&lt;ForestClientLocationDto&gt; response =</span>
<span class="fc" id="L223">          restTemplate.exchange(</span>
              apiUrl,
              HttpMethod.GET,
<span class="fc" id="L226">              new HttpEntity&lt;&gt;(addHttpHeaders()),</span>
<span class="fc" id="L227">              new ParameterizedTypeReference&lt;ForestClientLocationDto&gt;() {},</span>
<span class="fc" id="L228">              createParamsMap(&quot;clientNumber&quot;, clientNumber, &quot;locationCode&quot;, locationCode));</span>

<span class="fc" id="L230">      SparLog.info(</span>
          &quot;Finished {} request for function {} - 200 OK!&quot;, PROVIDER, &quot;fetchSingleClientLocation&quot;);
<span class="fc" id="L232">      return response.getBody();</span>
<span class="fc" id="L233">    } catch (HttpClientErrorException httpExc) {</span>
<span class="fc" id="L234">      SparLog.error(</span>
<span class="fc" id="L235">          &quot;Finished {} request - Response code error: {}&quot;, PROVIDER, httpExc.getStatusCode());</span>
<span class="fc" id="L236">      throw new ResponseStatusException(httpExc.getStatusCode(), httpExc.getMessage(), httpExc);</span>
    }
  }

  /**
   * Fetch the entire records of forest clients that matches the param.
   *
   * @param clientName the name of the clients to search for
   * @return a list of {@link ForestClientDto}
   */
  @Override
  public List&lt;ForestClientDto&gt; fetchClientsByClientName(String clientName) {
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">    if (shouldMock()) {</span>
<span class="nc" id="L249">      return List.of(mockForestClientDto(&quot;000012345&quot;));</span>
    }

<span class="fc" id="L252">    int page = 0;</span>
<span class="fc" id="L253">    int size = 50;</span>
<span class="fc" id="L254">    int totalFetched = 0;</span>
<span class="fc" id="L255">    int totalCount = Integer.MAX_VALUE;</span>
<span class="fc" id="L256">    List&lt;ForestClientDto&gt; result = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L258" title="All 2 branches covered.">    while (totalFetched &lt; totalCount) {</span>
      try {
<span class="fc" id="L260">        String uriBuilder =</span>
<span class="fc" id="L261">            UriComponentsBuilder.fromUriString(String.format(&quot;%s/clients/findByNames&quot;, rootUri))</span>
<span class="fc" id="L262">                .queryParam(&quot;page&quot;, &quot;{page}&quot;)</span>
<span class="fc" id="L263">                .queryParam(&quot;size&quot;, &quot;{size}&quot;)</span>
<span class="fc" id="L264">                .queryParam(&quot;clientName&quot;, &quot;{clientName}&quot;)</span>
<span class="fc" id="L265">                .encode()</span>
<span class="fc" id="L266">                .toUriString();</span>

<span class="fc" id="L268">        SparLog.info(&quot;Starting {} request to {}, Page {}&quot;, PROVIDER, uriBuilder, page);</span>

<span class="fc" id="L270">        ResponseEntity&lt;List&lt;ForestClientDto&gt;&gt; response =</span>
<span class="fc" id="L271">            restTemplate.exchange(</span>
                uriBuilder,
                HttpMethod.GET,
<span class="fc" id="L274">                new HttpEntity&lt;&gt;(addHttpHeaders()),</span>
<span class="fc" id="L275">                new ParameterizedTypeReference&lt;List&lt;ForestClientDto&gt;&gt;() {},</span>
<span class="fc" id="L276">                createParamsMap(</span>
                    &quot;page&quot;,
<span class="fc" id="L278">                    String.valueOf(page),</span>
                    &quot;size&quot;,
<span class="fc" id="L280">                    String.valueOf(size),</span>
                    &quot;clientName&quot;,
                    clientName));

<span class="fc" id="L284">        SparLog.info(</span>
            &quot;Finished {} request for function {}, Page {} - 200 OK!&quot;,
            PROVIDER,
            &quot;fetchClientsByClientName&quot;,
<span class="fc" id="L288">            page);</span>

<span class="fc" id="L290">        int responseSize = response.getBody().size();</span>

        // Empty response will not have a x-total-count header so we return the empty array here.
<span class="pc bpc" id="L293" title="1 of 2 branches missed.">        if (responseSize == 0) {</span>
<span class="nc" id="L294">          return result;</span>
        }

<span class="fc" id="L297">        totalCount = Integer.parseInt(response.getHeaders().get(&quot;x-total-count&quot;).get(0));</span>

<span class="fc" id="L299">        totalFetched += responseSize;</span>

<span class="fc" id="L301">        page += 1;</span>

<span class="fc" id="L303">        result.addAll(response.getBody());</span>
<span class="fc" id="L304">      } catch (HttpClientErrorException httpExc) {</span>
<span class="fc" id="L305">        SparLog.error(</span>
<span class="fc" id="L306">            &quot;Finished {} request - Response code error: {}&quot;, PROVIDER, httpExc.getStatusCode());</span>
<span class="fc" id="L307">        throw new ResponseStatusException(httpExc.getStatusCode(), httpExc.getMessage(), httpExc);</span>
<span class="fc" id="L308">      }</span>
    }

<span class="fc" id="L311">    SparLog.info(&quot;Found {} clients with the name of {}&quot;, result.size(), clientName);</span>

<span class="fc" id="L313">    return result;</span>
  }

  @Override
  public String[] addAuthorizationHeader() {
<span class="fc" id="L318">    String apiKey = this.providersConfig.getForestClientApiKey();</span>
<span class="fc" id="L319">    return new String[] {&quot;X-API-KEY&quot;, apiKey};</span>
  }

  @Override
  public HttpHeaders addHttpHeaders() {
<span class="fc" id="L324">    HttpHeaders headers = new HttpHeaders();</span>
<span class="fc" id="L325">    headers.set(&quot;Content-Type&quot;, MediaType.APPLICATION_JSON_VALUE);</span>
<span class="fc" id="L326">    String[] authorization = addAuthorizationHeader();</span>
<span class="fc" id="L327">    headers.set(authorization[0], authorization[1]);</span>

<span class="fc" id="L329">    return headers;</span>
  }

  /**
   * Checks if the response should be mocked. To enable it, register an environment variable called
   * BYPASS_FOREST_CLIENT and give it: Y. Note that is only possible to mock if this is not a prod
   * environment.
   *
   * @return a boolean. True if should mock, false otherwise.
   */
  private boolean shouldMock() {
<span class="fc" id="L340">    if (Arrays.stream(environment.getActiveProfiles())</span>
<span class="pc bpc" id="L341" title="2 of 4 branches missed.">        .anyMatch(env -&gt; !env.equalsIgnoreCase(&quot;prod&quot;))) {</span>
<span class="fc" id="L342">      String byPass = System.getenv(&quot;BYPASS_FOREST_CLIENT&quot;);</span>
<span class="fc" id="L343">      boolean shouldMockValue = &quot;Y&quot;.equals(byPass);</span>
<span class="fc" id="L344">      SparLog.info(&quot;Should mock ForestClient API request: {}&quot;, shouldMockValue);</span>
<span class="fc" id="L345">      return shouldMockValue;</span>
    }
<span class="nc" id="L347">    return false;</span>
  }

  private ForestClientDto mockForestClientDto(String number) {
<span class="nc" id="L351">    return new ForestClientDto(</span>
        number,
        &quot;name&quot;,
        &quot;firstName&quot;,
        &quot;legalMiddleName&quot;,
        ForestClientStatusEnum.ACT,
        ForestClientTypeEnum.A,
        &quot;acronym&quot;);
  }

  private ForestClientLocationDto mockForestClientLocationDto(String number, String location) {
<span class="nc" id="L362">    SparLog.info(&quot;Mocking ForestClientLocationDto for dev, testing, VPN purposes.&quot;);</span>
<span class="nc" id="L363">    return new ForestClientLocationDto(</span>
        number,
        location,
        &quot;locationName&quot;,
        &quot;company&quot;,
        &quot;&quot;,
        &quot;&quot;,
        &quot;&quot;,
        &quot;&quot;,
        &quot;&quot;,
        &quot;&quot;,
        &quot;&quot;,
        &quot;&quot;,
        &quot;&quot;,
        &quot;&quot;,
        &quot;&quot;,
        &quot;&quot;,
        ForestClientExpiredEnum.N,
        ForestClientExpiredEnum.Y,
        &quot;&quot;,
        &quot;&quot;);
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>