name: ETL Sync

on:
  schedule: [cron: "0 */2 * * *"] # Every other hour on the hour
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  sync-test:
    environment: test
    name: Sync (TEST)
    runs-on: ubuntu-latest
    steps:
      - name: Override OpenShift version
        env:
          OC: https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable-4.13/openshift-client-linux.tar.gz
        run: |
          # Download and extract with retry, continuing on error
          (wget ${{ env.OC }} -qcO - | tar -xzvf - oc)|| !! || true
          oc version
        working-directory: /usr/local/bin/

      - uses: actions/checkout@v4
      - name: ETL (TEST)
        run: ./sync/oc_run.sh test ${{ secrets.oc_token }}

  sync-prod:
    environment: prod
    name: Sync (PROD)
    runs-on: ubuntu-latest
    steps:
      - name: Override OpenShift version
        env:
          OC: https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable-4.13/openshift-client-linux.tar.gz
        run: |
          # Download and extract with retry, continuing on error
          (wget ${{ env.OC }} -qcO - | tar -xzvf - oc)|| !! || true
          oc version
        working-directory: /usr/local/bin/

      - uses: actions/checkout@v4
      - name: ETL (PROD)
        run: ./sync/oc_run.sh prod ${{ secrets.oc_token }}
