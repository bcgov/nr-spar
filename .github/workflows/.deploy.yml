name: .Deploy

on:
  workflow_call:
    inputs:
      ### Required
      target:
        description: PR number, test or prod
        required: true
        type: string

      ### Typical / recommended
      environment:
        description: GitHub environment; omit for PRs
        required: false
        type: string

      tag:
        description: GitHub package tag; omit for PRs
        required: false
        type: string

      triggers:
        description: Bash array to diff for build triggering; omit to always fire
        required: false
        type: string
      
      verify:
        description: Run the cronjob and verify results?  [true|false]
        required: false
        type: boolean
        default: true

env:
  CRONJOB: ${{ github.event.repository.name }}-${{ inputs.target }}-sync
  JOB_JOB: ${{ github.event.repository.name }}-${{ inputs.target }}-sync-${{ github.run_number }}

jobs:
  vars:
    name: Set Variables
    outputs:
      tag: ${{ steps.vars.outputs.tag }}
    runs-on: ubuntu-latest
    steps:
      # Get PR number for squash merges to main
      - name: PR Number
        id: pr
        uses: bcgov-nr/action-get-pr@v0.0.1

      - name: Set Variables
        id: vars
        run: |
          if [ -z "${{ inputs.tag }}" ]; then
            echo "No tag provided, using most recent PR merge number."
            echo "tag=${{ steps.pr.outputs.pr }}" >> $GITHUB_ENV
          else
            echo "Tag provided and being used for deployment."
            echo "tag=${{ inputs.tag }}" >> $GITHUB_ENV
          fi

  deploy:
    name: Deploy and Run Job
    needs: [vars]
    environment: ${{ inputs.environment }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy
        uses: bcgov-nr/action-deployer-openshift@v2.2.0
        with:
          file: sync/openshift.etl.yml
          oc_namespace: ${{ secrets.OC_NAMESPACE }}
          oc_server: ${{ vars.OC_SERVER }}
          oc_token: ${{ secrets.OC_TOKEN }}
          oc_version: 4.13
          overwrite: true
          parameters: -p ZONE=${{ inputs.target }} -p TAG=${{ needs.vars.outputs.tag }}
          post_rollout: oc create job ${{ env.JOB_JOB }} --from=cronjob/${{ env.CRONJOB }}
          triggers: ${{ inputs.triggers }}

  verify:
    name: Verify
    if: inputs.verify == true
    environment: ${{ inputs.environment }}
    needs: [deploy]
    runs-on: ubuntu-latest
    steps:
      - name: Verify
        run: |
          # Check job logs

          # Login
          oc login --token=${{ secrets.oc_token }} --server=${{ vars.oc_server }}
          oc project ${{ secrets.oc_namespace }} #Safeguard!

          # Follow
          oc wait --for=jsonpath='{.status.failed}'=4 job/${{ env.JOB_JOB }} --timeout=1m || true
          oc logs -l job-name=${{ env.JOB_JOB }} --tail=50 --follow

          # Results and exit code
          oc get job ${{ env.JOB_JOB }}

          if [ $(oc get job ${{ env.JOB_JOB }} -o jsonpath='{.status.ready}') -eq 0 ]; then
            echo "Job failed!"
            exit 1
          else
            echo "Job successful!"
            exit 0
          fi
