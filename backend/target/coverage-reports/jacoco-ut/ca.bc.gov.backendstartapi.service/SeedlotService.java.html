<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SeedlotService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">nr-spar-backend</a> &gt; <a href="index.source.html" class="el_package">ca.bc.gov.backendstartapi.service</a> &gt; <span class="el_source">SeedlotService.java</span></div><h1>SeedlotService.java</h1><pre class="source lang-java linenums">package ca.bc.gov.backendstartapi.service;

import ca.bc.gov.backendstartapi.config.Constants;
import ca.bc.gov.backendstartapi.config.SparLog;
import ca.bc.gov.backendstartapi.dto.GeneticWorthTraitsDto;
import ca.bc.gov.backendstartapi.dto.ParentTreeGeneticQualityDto;
import ca.bc.gov.backendstartapi.dto.SeedPlanZoneDto;
import ca.bc.gov.backendstartapi.dto.SeedlotAclassFormDto;
import ca.bc.gov.backendstartapi.dto.SeedlotApplicationPatchDto;
import ca.bc.gov.backendstartapi.dto.SeedlotCreateDto;
import ca.bc.gov.backendstartapi.dto.SeedlotCreateResponseDto;
import ca.bc.gov.backendstartapi.dto.SeedlotFormCollectionDto;
import ca.bc.gov.backendstartapi.dto.SeedlotFormExtractionDto;
import ca.bc.gov.backendstartapi.dto.SeedlotFormInterimDto;
import ca.bc.gov.backendstartapi.dto.SeedlotFormOrchardDto;
import ca.bc.gov.backendstartapi.dto.SeedlotFormOwnershipDto;
import ca.bc.gov.backendstartapi.dto.SeedlotFormParentTreeSmpDto;
import ca.bc.gov.backendstartapi.dto.SeedlotFormSubmissionDto;
import ca.bc.gov.backendstartapi.entity.ActiveOrchardSpuEntity;
import ca.bc.gov.backendstartapi.entity.GeneticClassEntity;
import ca.bc.gov.backendstartapi.entity.SeedlotGeneticWorth;
import ca.bc.gov.backendstartapi.entity.SeedlotParentTree;
import ca.bc.gov.backendstartapi.entity.SeedlotParentTreeGeneticQuality;
import ca.bc.gov.backendstartapi.entity.SeedlotParentTreeSmpMix;
import ca.bc.gov.backendstartapi.entity.SeedlotSeedPlanZoneEntity;
import ca.bc.gov.backendstartapi.entity.SeedlotSourceEntity;
import ca.bc.gov.backendstartapi.entity.SeedlotStatusEntity;
import ca.bc.gov.backendstartapi.entity.SmpMix;
import ca.bc.gov.backendstartapi.entity.SmpMixGeneticQuality;
import ca.bc.gov.backendstartapi.entity.embeddable.AuditInformation;
import ca.bc.gov.backendstartapi.entity.idclass.SeedlotParentTreeId;
import ca.bc.gov.backendstartapi.entity.seedlot.Seedlot;
import ca.bc.gov.backendstartapi.entity.seedlot.SeedlotOrchard;
import ca.bc.gov.backendstartapi.entity.seedlot.idclass.SeedlotSeedPlanZoneId;
import ca.bc.gov.backendstartapi.exception.InvalidSeedlotRequestException;
import ca.bc.gov.backendstartapi.exception.SeedlotFormValidationException;
import ca.bc.gov.backendstartapi.exception.SeedlotNotFoundException;
import ca.bc.gov.backendstartapi.exception.SeedlotOrchardNotFoundException;
import ca.bc.gov.backendstartapi.exception.SeedlotSourceNotFoundException;
import ca.bc.gov.backendstartapi.exception.SeedlotStatusNotFoundException;
import ca.bc.gov.backendstartapi.provider.Provider;
import ca.bc.gov.backendstartapi.repository.GeneticClassRepository;
import ca.bc.gov.backendstartapi.repository.SeedlotCollectionMethodRepository;
import ca.bc.gov.backendstartapi.repository.SeedlotOwnerQuantityRepository;
import ca.bc.gov.backendstartapi.repository.SeedlotRepository;
import ca.bc.gov.backendstartapi.repository.SeedlotSeedPlanZoneRepository;
import ca.bc.gov.backendstartapi.repository.SeedlotSourceRepository;
import ca.bc.gov.backendstartapi.repository.SeedlotStatusRepository;
import ca.bc.gov.backendstartapi.security.LoggedUserService;
import jakarta.transaction.Transactional;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.function.Function;
import java.util.stream.Collectors;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.data.domain.Sort.Direction;
import org.springframework.lang.NonNull;
import org.springframework.stereotype.Service;

/** This class contains methods for handling Seedlots in the database. */
<span class="fc" id="L70">@RequiredArgsConstructor</span>
@Service
public class SeedlotService {

  private final SeedlotRepository seedlotRepository;

  private final SeedlotSourceRepository seedlotSourceRepository;

  private final SeedlotStatusRepository seedlotStatusRepository;

  private final GeneticClassRepository geneticClassRepository;

  private final LoggedUserService loggedUserService;

  private final SeedlotCollectionMethodService seedlotCollectionMethodService;

  private final SeedlotCollectionMethodRepository seedlotCollectionMethodRepository;

  private final SeedlotOwnerQuantityService seedlotOwnerQuantityService;

  private final SeedlotOwnerQuantityRepository seedlotOwnerQuantityRepository;

  private final SeedlotOrchardService seedlotOrchardService;

  private final SeedlotParentTreeService seedlotParentTreeService;

  private final SeedlotParentTreeGeneticQualityService seedlotParentTreeGeneticQualityService;

  private final SeedlotGeneticWorthService seedlotGeneticWorthService;

  private final SmpMixService smpMixService;

  private final SmpMixGeneticQualityService smpMixGeneticQualityService;

  private final SeedlotParentTreeSmpMixService seedlotParentTreeSmpMixService;

  private final SeedlotStatusService seedlotStatusService;

  private final OrchardService orchardService;

  private final SeedlotSeedPlanZoneRepository seedlotSeedPlanZoneRepository;

  @Qualifier(&quot;oracleApi&quot;)
  private final Provider oracleApiProvider;

  /**
   * Creates a Seedlot in the database.
   *
   * @param createDto A {@link SeedlotCreateDto} with required fields to create a seedlot.
   * @return A {@link SeedlotCreateResponseDto} containing the number and the status of the created
   *     seedlot.
   */
  @Transactional
  public SeedlotCreateResponseDto createSeedlot(SeedlotCreateDto createDto) {
<span class="fc" id="L124">    SparLog.info(&quot;Create Seedlot started.&quot;);</span>

<span class="fc" id="L126">    Seedlot seedlot = new Seedlot(nextSeedlotNumber(createDto.geneticClassCode()));</span>

<span class="fc" id="L128">    Optional&lt;SeedlotStatusEntity&gt; seedLotStatusEntity =</span>
<span class="fc" id="L129">        seedlotStatusRepository.findById(Constants.CLASS_A_SEEDLOT_STATUS);</span>
<span class="fc" id="L130">    seedlot.setSeedlotStatus(seedLotStatusEntity.orElseThrow(InvalidSeedlotRequestException::new));</span>

<span class="fc" id="L132">    seedlot.setApplicantClientNumber(createDto.applicantClientNumber());</span>
<span class="fc" id="L133">    seedlot.setApplicantLocationCode(createDto.applicantLocationCode());</span>
<span class="fc" id="L134">    seedlot.setApplicantEmailAddress(createDto.applicantEmailAddress());</span>
<span class="fc" id="L135">    seedlot.setVegetationCode(createDto.vegetationCode());</span>

<span class="fc" id="L137">    Optional&lt;GeneticClassEntity&gt; classEntity =</span>
<span class="fc" id="L138">        geneticClassRepository.findById(createDto.geneticClassCode().toString());</span>
<span class="fc" id="L139">    seedlot.setGeneticClass(classEntity.orElseThrow(InvalidSeedlotRequestException::new));</span>

<span class="fc" id="L141">    Optional&lt;SeedlotSourceEntity&gt; seedlotSourceEntity =</span>
<span class="fc" id="L142">        seedlotSourceRepository.findById(createDto.seedlotSourceCode());</span>
<span class="fc" id="L143">    seedlot.setSeedlotSource(seedlotSourceEntity.orElseThrow(InvalidSeedlotRequestException::new));</span>

<span class="fc" id="L145">    seedlot.setIntendedForCrownLand(createDto.toBeRegistrdInd());</span>
<span class="fc" id="L146">    seedlot.setSourceInBc(createDto.bcSourceInd());</span>
<span class="fc" id="L147">    seedlot.setAuditInformation(new AuditInformation(loggedUserService.getLoggedUserId()));</span>

<span class="fc" id="L149">    SparLog.debug(&quot;Seedlot to insert: {}&quot;, seedlot);</span>

<span class="fc" id="L151">    seedlotRepository.save(seedlot);</span>

<span class="fc" id="L153">    SparLog.info(&quot;New seedlot saved with success!&quot;);</span>

<span class="fc" id="L155">    return new SeedlotCreateResponseDto(</span>
<span class="fc" id="L156">        seedlot.getId(), seedlot.getSeedlotStatus().getSeedlotStatusCode());</span>
  }

  /**
   * Retrieved the next Seedlot number according to genetic class.
   *
   * @return A String containing the next number.
   * @throws InvalidSeedlotRequestException in case of errors.
   */
  private String nextSeedlotNumber(Character seedlotClassCode) {
<span class="fc" id="L166">    SparLog.info(&quot;Retrieving next seedlot number for class-{}&quot;, seedlotClassCode);</span>

<span class="fc bfc" id="L168" title="All 2 branches covered.">    if (seedlotClassCode.equals('B')) {</span>
<span class="fc" id="L169">      SparLog.error(&quot;Class-b seedlots not implemented yet!&quot;);</span>
<span class="fc" id="L170">      throw new InvalidSeedlotRequestException();</span>
    }

<span class="fc" id="L173">    Integer seedlotNumber =</span>
<span class="fc" id="L174">        seedlotRepository.findNextSeedlotNumber(</span>
            Constants.CLASS_A_SEEDLOT_NUM_MIN, Constants.CLASS_A_SEEDLOT_NUM_MAX);

<span class="pc bpc" id="L177" title="1 of 2 branches missed.">    if (Objects.isNull(seedlotNumber)) {</span>
<span class="nc" id="L178">      seedlotNumber = Constants.CLASS_A_SEEDLOT_NUM_MIN;</span>
    }

<span class="fc" id="L181">    seedlotNumber += 1;</span>

<span class="fc" id="L183">    SparLog.info(&quot;Next seedlot number for class-{} {}&quot;, seedlotClassCode, seedlotNumber);</span>
<span class="fc" id="L184">    return String.valueOf(seedlotNumber);</span>
  }

  /**
   * Retrieve a paginated list of seedlot for a given user.
   *
   * @param userId the id of the user to fetch the seedlots for
   * @param pageNumber the page number for the paginated search
   * @param pageSize the size of the page
   * @return a list of the user's seedlots
   */
  public Optional&lt;Page&lt;Seedlot&gt;&gt; getUserSeedlots(String userId, int pageNumber, int pageSize) {
<span class="fc" id="L196">    SparLog.info(&quot;Retrieving paginated list of seedlots for the user {}&quot;, userId);</span>
<span class="fc bfc" id="L197" title="All 2 branches covered.">    if (pageSize == 0) {</span>
<span class="fc" id="L198">      SparLog.info(&quot;No given value for the page size, using default 10.&quot;);</span>
<span class="fc" id="L199">      pageSize = 10;</span>
    }

<span class="fc" id="L202">    SparLog.info(&quot;Pagination settings: pageNumber {}, pageSize {}&quot;, pageNumber, pageSize);</span>
<span class="fc" id="L203">    Pageable sortedPageable =</span>
<span class="fc" id="L204">        PageRequest.of(</span>
<span class="fc" id="L205">            pageNumber, pageSize, Sort.by(Direction.DESC, &quot;AuditInformation_UpdateTimestamp&quot;));</span>

<span class="fc" id="L207">    Page&lt;Seedlot&gt; seedlotPage =</span>
<span class="fc" id="L208">        seedlotRepository.findAllByAuditInformation_EntryUserId(userId, sortedPageable);</span>
<span class="fc" id="L209">    SparLog.info(&quot;{} results and {} pages&quot;, seedlotPage.getNumber(), seedlotPage.getTotalPages());</span>
<span class="fc" id="L210">    return Optional.of(seedlotPage);</span>
  }

  /**
   * Retrieve a single seedlot information.
   *
   * @param seedlotNumber the seedlot number of the seedlot to fetch the information
   * @return A Seedlot entity.
   * @throws SeedlotNotFoundException in case of errors.
   */
  public Seedlot getSingleSeedlotInfo(@NonNull String seedlotNumber) {
<span class="fc" id="L221">    SparLog.info(&quot;Retrieving information for Seedlot number {}&quot;, seedlotNumber);</span>

<span class="fc" id="L223">    Seedlot seedlotInfo =</span>
<span class="fc" id="L224">        seedlotRepository.findById(seedlotNumber).orElseThrow(SeedlotNotFoundException::new);</span>

<span class="fc" id="L226">    SparLog.info(&quot;Seedlot number {} found&quot;, seedlotNumber);</span>
<span class="fc" id="L227">    return seedlotInfo;</span>
  }

  /**
   * Auxiliar function to get the genetic quality for each seedlot's parent
   * tree.
   *
   * @param parentTreeId the parent tree id to get the genetic quality
   * @param seedlotNumber the seedlot that the current parent tree is
   * @return a list of {@link ParentTreeGeneticQualityDto}
   */
  private List&lt;ParentTreeGeneticQualityDto&gt; getParentTreeGenQual(
      Integer parentTreeId,
      String seedlotNumber
  ) {
<span class="fc" id="L242">    List&lt;SeedlotParentTreeGeneticQuality&gt; genQualityData =</span>
<span class="fc" id="L243">        seedlotParentTreeGeneticQualityService.getAllBySeedlotNumber(seedlotNumber);</span>

<span class="fc" id="L245">    List&lt;ParentTreeGeneticQualityDto&gt; parentTreeGenQualList = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L247" title="All 2 branches covered.">    for (SeedlotParentTreeGeneticQuality parentTreeGenQual : genQualityData) {</span>
<span class="fc" id="L248">      Integer curParentTreeId = parentTreeGenQual.getId().getSeedlotParentTree().getParentTreeId();</span>
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">      if (curParentTreeId == parentTreeId) {</span>
<span class="fc" id="L250">        ParentTreeGeneticQualityDto parentTreeGenQualDto =</span>
            new ParentTreeGeneticQualityDto(
<span class="fc" id="L252">              parentTreeGenQual.getGeneticTypeCode(),</span>
<span class="fc" id="L253">              parentTreeGenQual.getGeneticWorth().getGeneticWorthCode(),</span>
<span class="fc" id="L254">              parentTreeGenQual.getGeneticQualityValue()</span>
            );
<span class="fc" id="L256">        parentTreeGenQualList.add(parentTreeGenQualDto);</span>
      }
<span class="fc" id="L258">    }</span>

<span class="fc" id="L260">    return parentTreeGenQualList;</span>
  }

  /**
   * Auxiliar function to get the genetic quality for each seedlot's SMP Mix
   * parent tree.
   *
   * @param mixTabInfo the Smp mix parent tree information
   * @param seedlotNumber the seedlot that the current parent tree is
   * @param sptMap a map of each parent tree in the orchard, to check if
   *               any smp mix parent tree is in the orchard or not
   * @return a list of {@link ParentTreeGeneticQualityDto}
   */
  private List&lt;ParentTreeGeneticQualityDto&gt; getSmpMixParentTreeGenQual(
      SmpMix mixTabInfo,
      String seedlotNumber,
      Map&lt;SeedlotParentTreeId, SeedlotParentTree&gt; sptMap
  ) {
<span class="fc" id="L278">    List&lt;SmpMixGeneticQuality&gt; smpMixGenQualData =</span>
<span class="fc" id="L279">        smpMixGeneticQualityService.getAllBySeedlotNumber(seedlotNumber);</span>

<span class="fc" id="L281">    List&lt;SeedlotParentTreeSmpMix&gt; parentTreeSmpMixData =</span>
<span class="fc" id="L282">        seedlotParentTreeSmpMixService.getAllBySeedlotNumber(seedlotNumber);</span>

<span class="fc" id="L284">    List&lt;ParentTreeGeneticQualityDto&gt; smpMixGenQualList = new ArrayList&lt;&gt;();</span>

    // If the current parent tree is in the orchard and also on the SMP Mix,
    // then, the genetic quality data comes from SeedlotParentTreeSmpMix list,
    // else, the gen quality data comes from SmpMixGeneticQuality
<span class="pc bpc" id="L289" title="1 of 2 branches missed.">    if (sptMap.containsKey(mixTabInfo.getSeedlotParentTreeId())) {</span>
<span class="fc bfc" id="L290" title="All 2 branches covered.">      for (SeedlotParentTreeSmpMix sptSmpMixGenQual : parentTreeSmpMixData) {</span>
<span class="fc" id="L291">        Integer parentTreeId = sptSmpMixGenQual.getId().getSeedlotParentTree().getParentTreeId();</span>
<span class="pc bpc" id="L292" title="1 of 2 branches missed.">        if (parentTreeId == mixTabInfo.getParentTreeId()) {</span>
<span class="fc" id="L293">          ParentTreeGeneticQualityDto parentTreeGenQualDto =</span>
              new ParentTreeGeneticQualityDto(
<span class="fc" id="L295">                sptSmpMixGenQual.getGeneticTypeCode(),</span>
<span class="fc" id="L296">                sptSmpMixGenQual.getGeneticWorth().getGeneticWorthCode(),</span>
<span class="fc" id="L297">                sptSmpMixGenQual.getGeneticQualityValue()</span>
              );
<span class="fc" id="L299">          smpMixGenQualList.add(parentTreeGenQualDto);</span>
        }
<span class="fc" id="L301">      }</span>
    } else {
<span class="nc bnc" id="L303" title="All 2 branches missed.">      for (SmpMixGeneticQuality smpMixGenQual : smpMixGenQualData) {</span>
<span class="nc" id="L304">        Integer parentTreeId = smpMixGenQual.getId().getSmpMix().getParentTreeId();</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">        if (parentTreeId.equals(mixTabInfo.getParentTreeId())) {</span>
<span class="nc" id="L306">          ParentTreeGeneticQualityDto parentTreeGenQualDto =</span>
              new ParentTreeGeneticQualityDto(
<span class="nc" id="L308">                smpMixGenQual.getGeneticTypeCode(),</span>
<span class="nc" id="L309">                smpMixGenQual.getGeneticWorth().getGeneticWorthCode(),</span>
<span class="nc" id="L310">                smpMixGenQual.getGeneticQualityValue()</span>
              );
<span class="nc" id="L312">          smpMixGenQualList.add(parentTreeGenQualDto);</span>
        }
<span class="nc" id="L314">      }</span>
    }

<span class="fc" id="L317">    return smpMixGenQualList;</span>
  }

  /**
   * Retrieve a single seedlot information, with all parent tree data and calculation results.
   *
   * @param seedlotNumber the seedlot number of the seedlot to fetch the information
   * @return A {@link SeedlotAclassFormDto} containing the number and the status of the created
   *         seedlot.
   * @throws SeedlotNotFoundException in case of errors.
   */
  public SeedlotAclassFormDto getAclassSeedlotFormInfo(@NonNull String seedlotNumber) {
<span class="fc" id="L329">    SparLog.info(&quot;Retrieving complete information for A-class Seedlot number {}&quot;, seedlotNumber);</span>

<span class="fc" id="L331">    List&lt;SeedlotParentTree&gt; parentTreeData =</span>
<span class="fc" id="L332">        seedlotParentTreeService.getAllSeedlotParentTree(seedlotNumber);</span>

<span class="fc" id="L334">    List&lt;SmpMix&gt; smpMixsData = smpMixService.getAllBySeedlotNumber(seedlotNumber);</span>

<span class="fc" id="L336">    List&lt;SeedlotGeneticWorth&gt; genWorthData =</span>
<span class="fc" id="L337">        seedlotGeneticWorthService.getAllBySeedlotNumber(seedlotNumber);</span>

<span class="fc" id="L339">    List&lt;SeedlotFormParentTreeSmpDto&gt; parentTreesInfo = new ArrayList&lt;&gt;();</span>

    // Iterate thru the seedlot parent tree list and get these
    // seedlot data
<span class="fc bfc" id="L343" title="All 2 branches covered.">    for (SeedlotParentTree parentTree : parentTreeData) {</span>
<span class="fc" id="L344">      SeedlotFormParentTreeSmpDto curParentTree = new SeedlotFormParentTreeSmpDto(</span>
          seedlotNumber,
<span class="fc" id="L346">          parentTree.getParentTreeId(),</span>
<span class="fc" id="L347">          parentTree.getParentTreeNumber(),</span>
<span class="fc" id="L348">          parentTree.getConeCount(),</span>
<span class="fc" id="L349">          parentTree.getPollenCount(),</span>
<span class="fc" id="L350">          parentTree.getSmpSuccessPercentage(),</span>
<span class="fc" id="L351">          parentTree.getNonOrchardPollenContaminationCount(),</span>
          null,
          null,
<span class="fc" id="L354">          getParentTreeGenQual(parentTree.getParentTreeId(), seedlotNumber)</span>
      );

<span class="fc" id="L357">      parentTreesInfo.add(curParentTree);</span>
<span class="fc" id="L358">    }</span>

<span class="fc" id="L360">    List&lt;SeedlotFormParentTreeSmpDto&gt; smpMixParentTreesInfo = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L362" title="All 2 branches covered.">    if (smpMixsData.size() &gt; 0) {</span>
      // This map is used to see if any SMPMix parent tree
      // are in the current orchard
<span class="fc" id="L365">      Map&lt;SeedlotParentTreeId, SeedlotParentTree&gt; sptMap =</span>
<span class="fc" id="L366">          parentTreeData.stream().collect(Collectors</span>
<span class="fc" id="L367">          .toMap(SeedlotParentTree::getId, Function.identity()));</span>

<span class="fc bfc" id="L369" title="All 2 branches covered.">      for (SmpMix mixTabInfo : smpMixsData) {</span>
<span class="fc" id="L370">        SeedlotFormParentTreeSmpDto curSmpMix = new SeedlotFormParentTreeSmpDto(</span>
            seedlotNumber,
<span class="fc" id="L372">            mixTabInfo.getParentTreeId(),</span>
<span class="fc" id="L373">            mixTabInfo.getParentTreeNumber(),</span>
            null,
            null,
            null,
            null,
<span class="fc" id="L378">            mixTabInfo.getAmountOfMaterial(),</span>
<span class="fc" id="L379">            mixTabInfo.getProportion(),</span>
<span class="fc" id="L380">            getSmpMixParentTreeGenQual(mixTabInfo, seedlotNumber, sptMap)</span>
        );
<span class="fc" id="L382">        smpMixParentTreesInfo.add(curSmpMix);</span>
<span class="fc" id="L383">      }</span>
    }

<span class="fc" id="L386">    List&lt;GeneticWorthTraitsDto&gt; calculatedGenWorth = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L388" title="All 2 branches covered.">    for (SeedlotGeneticWorth genWorth : genWorthData) {</span>
<span class="fc" id="L389">      GeneticWorthTraitsDto curGenWorth = new GeneticWorthTraitsDto(</span>
<span class="fc" id="L390">          genWorth.getGeneticWorthCode(),</span>
          null,
<span class="fc" id="L392">          genWorth.getGeneticQualityValue(),</span>
<span class="fc" id="L393">          genWorth.getTestedParentTreeContributionPercentage()</span>
      );
<span class="fc" id="L395">      calculatedGenWorth.add(curGenWorth);</span>
<span class="fc" id="L396">    }</span>

    // Get seedlot data
<span class="fc" id="L399">    Seedlot seedlotInfo =</span>
<span class="fc" id="L400">        seedlotRepository.findById(seedlotNumber).orElseThrow(SeedlotNotFoundException::new);</span>

<span class="fc" id="L402">    List&lt;Integer&gt; seedlotCollectionList =</span>
<span class="fc" id="L403">        seedlotCollectionMethodRepository.findAllBySeedlot_id(seedlotInfo.getId()).stream()</span>
<span class="fc" id="L404">        .map(col -&gt; col.getConeCollectionMethod().getConeCollectionMethodCode())</span>
<span class="fc" id="L405">        .collect(Collectors.toList());</span>

    // Divide the seedlot data to each respective step
<span class="fc" id="L408">    SeedlotFormCollectionDto collectionStep = new SeedlotFormCollectionDto(</span>
<span class="fc" id="L409">        seedlotInfo.getCollectionClientNumber(),</span>
<span class="fc" id="L410">        seedlotInfo.getCollectionLocationCode(),</span>
<span class="fc" id="L411">        seedlotInfo.getCollectionStartDate(),</span>
<span class="fc" id="L412">        seedlotInfo.getCollectionEndDate(),</span>
<span class="fc" id="L413">        seedlotInfo.getNumberOfContainers(),</span>
<span class="fc" id="L414">        seedlotInfo.getContainerVolume(),</span>
<span class="fc" id="L415">        seedlotInfo.getTotalConeVolume(),</span>
<span class="fc" id="L416">        seedlotInfo.getComment(),</span>
        seedlotCollectionList
    );

<span class="fc" id="L420">    List&lt;SeedlotFormOwnershipDto&gt; ownershipStep =</span>
<span class="fc" id="L421">        seedlotOwnerQuantityRepository.findAllBySeedlot_id(seedlotInfo.getId()).stream()</span>
<span class="fc" id="L422">        .map(owner -&gt; new SeedlotFormOwnershipDto(</span>
<span class="fc" id="L423">            owner.getOwnerClientNumber(),</span>
<span class="fc" id="L424">            owner.getOwnerLocationCode(),</span>
<span class="fc" id="L425">            owner.getOriginalPercentageOwned(),</span>
<span class="fc" id="L426">            owner.getOriginalPercentageReserved(),</span>
<span class="fc" id="L427">            owner.getOriginalPercentageSurplus(),</span>
<span class="fc" id="L428">            owner.getMethodOfPayment().getMethodOfPaymentCode(),</span>
<span class="fc" id="L429">            owner.getFundingSourceCode()</span>
        ))
<span class="fc" id="L431">        .collect(Collectors.toList());</span>

<span class="fc" id="L433">    SeedlotFormInterimDto interimStep = new SeedlotFormInterimDto(</span>
<span class="fc" id="L434">        seedlotInfo.getInterimStorageClientNumber(),</span>
<span class="fc" id="L435">        seedlotInfo.getInterimStorageLocationCode(),</span>
<span class="fc" id="L436">        seedlotInfo.getInterimStorageStartDate(),</span>
<span class="fc" id="L437">        seedlotInfo.getInterimStorageEndDate(),</span>
<span class="fc" id="L438">        seedlotInfo.getInterimStorageOtherFacilityDesc(),</span>
<span class="fc" id="L439">        seedlotInfo.getInterimStorageFacilityCode());</span>

<span class="fc" id="L441">    List&lt;String&gt; seedlotOrchards =</span>
<span class="fc" id="L442">        seedlotOrchardService.getAllSeedlotOrchardBySeedlotNumber(seedlotInfo.getId()).stream()</span>
<span class="fc" id="L443">            .map(SeedlotOrchard::getOrchard)</span>
<span class="fc" id="L444">            .toList();;</span>

<span class="fc" id="L446">    SeedlotFormOrchardDto orchardStep = new SeedlotFormOrchardDto(</span>
        seedlotOrchards,
<span class="fc" id="L448">        seedlotInfo.getFemaleGameticContributionMethod(),</span>
<span class="fc" id="L449">        seedlotInfo.getMaleGameticContributionMethod(),</span>
<span class="fc" id="L450">        seedlotInfo.getProducedThroughControlledCross(),</span>
<span class="fc" id="L451">        seedlotInfo.getProducedWithBiotechnologicalProcesses(),</span>
<span class="fc" id="L452">        seedlotInfo.getPollenContaminationPresentInOrchard(),</span>
<span class="fc" id="L453">        seedlotInfo.getPollenContaminationPercentage(),</span>
<span class="fc" id="L454">        seedlotInfo.getPollenContaminantBreedingValue(),</span>
<span class="fc" id="L455">        seedlotInfo.getPollenContaminationMethodCode());</span>

<span class="fc" id="L457">    SeedlotFormExtractionDto extractionStep = new SeedlotFormExtractionDto(</span>
<span class="fc" id="L458">        seedlotInfo.getExtractionClientNumber(),</span>
<span class="fc" id="L459">        seedlotInfo.getExtractionLocationCode(),</span>
<span class="fc" id="L460">        seedlotInfo.getExtractionStartDate(),</span>
<span class="fc" id="L461">        seedlotInfo.getExtractionEndDate(),</span>
<span class="fc" id="L462">        seedlotInfo.getStorageClientNumber(),</span>
<span class="fc" id="L463">        seedlotInfo.getStorageLocationCode(),</span>
<span class="fc" id="L464">        seedlotInfo.getTemporaryStorageStartDate(),</span>
<span class="fc" id="L465">        seedlotInfo.getTemporaryStorageEndDate());</span>

<span class="fc" id="L467">    SeedlotAclassFormDto seedlotAclassFullInfo = new SeedlotAclassFormDto(</span>
        new SeedlotFormSubmissionDto(
            collectionStep,
            ownershipStep,
            interimStep,
            orchardStep,
            parentTreesInfo,
            smpMixParentTreesInfo,
            extractionStep
        ),
        calculatedGenWorth
    );

<span class="fc" id="L480">    SparLog.info(&quot;Seedlot registration info found for seedlot {}&quot;, seedlotNumber);</span>
<span class="fc" id="L481">    return seedlotAclassFullInfo;</span>
  }

  /**
   * Update an entry in the Seedlot table.
   *
   * @param seedlotNumber the seedlot number of the seedlot to fetch the information
   * @return A Seedlot entity.
   * @throws SeedlotNotFoundException in case of seedlot not found error.
   * @throws SeedlotSourceNotFoundException in case of seedlot source not found error.
   */
  public Seedlot patchApplicantionInfo(
      @NonNull String seedlotNumber, SeedlotApplicationPatchDto patchDto) {
<span class="fc" id="L494">    SparLog.info(&quot;Patching seedlot entry for seedlot number {}&quot;, seedlotNumber);</span>

<span class="fc" id="L496">    Seedlot seedlotInfo =</span>
<span class="fc" id="L497">        seedlotRepository.findById(seedlotNumber).orElseThrow(SeedlotNotFoundException::new);</span>

<span class="fc" id="L499">    SparLog.info(&quot;Seedlot number {} found&quot;, seedlotNumber);</span>

<span class="fc" id="L501">    seedlotInfo.setApplicantEmailAddress(patchDto.applicantEmailAddress());</span>

<span class="fc" id="L503">    SeedlotSourceEntity updatedSource =</span>
        seedlotSourceRepository
<span class="fc" id="L505">            .findById(patchDto.seedlotSourceCode())</span>
<span class="fc" id="L506">            .orElseThrow(SeedlotSourceNotFoundException::new);</span>

<span class="fc" id="L508">    seedlotInfo.setSeedlotSource(updatedSource);</span>

<span class="fc" id="L510">    seedlotInfo.setSourceInBc(patchDto.bcSourceInd());</span>

    // The field intendedForCrownLand == to be registered indicator.
<span class="fc" id="L513">    seedlotInfo.setIntendedForCrownLand(patchDto.toBeRegistrdInd());</span>

<span class="fc" id="L515">    Seedlot seedlotSaved = seedlotRepository.save(seedlotInfo);</span>
<span class="fc" id="L516">    SparLog.info(&quot;Seedlot number {} successfully patched&quot;, seedlotNumber);</span>
<span class="fc" id="L517">    return seedlotSaved;</span>
  }

  /**
   * Saved the entire {@link Seedlot} form with all steps.
   *
   * @param seedlotNumber The Seedlot identification
   * @param form The {@link SeedlotFormSubmissionDto} containing all form fields
   * @return A {@link SeedlotCreateResponseDto} with the seedlot number and status
   */
  @Transactional
  public SeedlotCreateResponseDto submitSeedlotForm(
      String seedlotNumber, SeedlotFormSubmissionDto form) {
<span class="fc" id="L530">    SparLog.info(&quot;Seedlot number {} submitted for saving!&quot;, seedlotNumber);</span>
<span class="fc" id="L531">    Optional&lt;Seedlot&gt; seedlotEntity = seedlotRepository.findById(seedlotNumber);</span>
<span class="fc" id="L532">    Seedlot seedlot = seedlotEntity.orElseThrow(SeedlotNotFoundException::new);</span>

    /*
     * Merging entities script:
     * 1. Finds all for that seedlot
     * 2. Iterate over the result list
     * 3. Remove all existing entries except the seedlot row in the seedlot table
     * 5. Add new ones
     */

    // Collection step 1
<span class="fc" id="L543">    seedlotCollectionMethodService.saveSeedlotFormStep1(seedlot, form.seedlotFormCollectionDto());</span>
    // Owner step 2
<span class="fc" id="L545">    seedlotOwnerQuantityService.saveSeedlotFormStep2(seedlot, form.seedlotFormOwnershipDtoList());</span>
    // Interim Step 3
<span class="fc" id="L547">    saveSeedlotFormStep3(seedlot, form.seedlotFormInterimDto());</span>
    // Orchard Step 4
<span class="fc" id="L549">    seedlotOrchardService.saveSeedlotFormStep4(seedlot, form.seedlotFormOrchardDto());</span>
    // Parent Tree Step 5
<span class="fc" id="L551">    saveSeedlotFormStep5(</span>
<span class="fc" id="L552">        seedlot, form.seedlotFormParentTreeDtoList(), form.seedlotFormParentTreeSmpDtoList());</span>
    // Extraction Step 6
<span class="fc" id="L554">    saveSeedlotFormStep6(seedlot, form.seedlotFormExtractionDto());</span>

<span class="fc" id="L556">    String submittedStatus = &quot;SUB&quot;;</span>
<span class="fc" id="L557">    setSeedlotStatus(seedlot, submittedStatus);</span>

<span class="fc" id="L559">    setSeedlotSpzInformation(seedlot);</span>

<span class="fc" id="L561">    SparLog.info(&quot;Saving the Seedlot Entity for seedlot number {}&quot;, seedlotNumber);</span>
<span class="fc" id="L562">    seedlotRepository.save(seedlot);</span>

<span class="fc" id="L564">    SparLog.info(&quot;Seedlot entity and related tables successfully saved.&quot;);</span>
<span class="fc" id="L565">    return new SeedlotCreateResponseDto(</span>
<span class="fc" id="L566">        seedlotNumber, seedlot.getSeedlotStatus().getSeedlotStatusCode());</span>
  }

  /**
   * Get all the seed plan zone information given a seedlot number.
   *
   * @param seedlotNumber the Seedlot id
   * @return A list of {@link SeedPlanZoneDto} containing all records.
   * @throws SeedlotNotFoundException if seedlot was not found.
   * @throws SeedlotOrchardNotFoundException if no orchard found for the seedlot.
   */
  public List&lt;SeedPlanZoneDto&gt; getSeedPlanZoneData(String seedlotNumber) {
<span class="fc" id="L578">    SparLog.info(&quot;Getting Seed Plan Zone data for seedlot number {}&quot;, seedlotNumber);</span>

<span class="fc" id="L580">    SparLog.info(&quot;Fetching seedlot entity&quot;);</span>
<span class="fc" id="L581">    Optional&lt;Seedlot&gt; seedlotOp = seedlotRepository.findById(seedlotNumber);</span>
<span class="pc bpc" id="L582" title="1 of 2 branches missed.">    if (seedlotOp.isEmpty()) {</span>
<span class="nc" id="L583">      throw new SeedlotNotFoundException();</span>
    }

<span class="fc" id="L586">    SparLog.info(&quot;Fetching seedlot seed plan zone entity&quot;);</span>
<span class="fc" id="L587">    List&lt;SeedlotSeedPlanZoneEntity&gt; sspzList =</span>
<span class="fc" id="L588">        seedlotSeedPlanZoneRepository.findAllBySeedlot_id(seedlotNumber);</span>

<span class="fc" id="L590">    SparLog.info(&quot;Fetching seedlot orchard entity&quot;);</span>
<span class="fc" id="L591">    List&lt;String&gt; orchardIdList =</span>
<span class="fc" id="L592">        seedlotOrchardService.getAllSeedlotOrchardBySeedlotNumber(seedlotNumber).stream()</span>
<span class="fc" id="L593">            .map(SeedlotOrchard::getOrchard)</span>
<span class="fc" id="L594">            .toList();</span>

<span class="pc bpc" id="L596" title="1 of 2 branches missed.">    if (orchardIdList.isEmpty()) {</span>
<span class="nc" id="L597">      SparLog.warn(&quot;No orchard record found for the seedlot&quot;);</span>
<span class="nc" id="L598">      throw new SeedlotOrchardNotFoundException();</span>
    }

<span class="fc" id="L601">    List&lt;SeedPlanZoneDto&gt; spzDtoList = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L603" title="All 2 branches covered.">    for (String orchardId : orchardIdList) {</span>
<span class="fc" id="L604">      SparLog.info(&quot;Fetching active orchard seed plannining unit entity&quot;);</span>

<span class="fc" id="L606">      Optional&lt;ActiveOrchardSpuEntity&gt; spuOp =</span>
<span class="fc" id="L607">          orchardService.findSpuIdByOrchardWithActive(orchardId, true);</span>
<span class="pc bpc" id="L608" title="1 of 2 branches missed.">      if (spuOp.isEmpty()) {</span>
<span class="nc" id="L609">        SparLog.warn(&quot;No ActiveOrchardSpuEntity record found for orchard id {}&quot;, orchardId);</span>
<span class="nc" id="L610">        continue;</span>
      }

<span class="fc" id="L613">      Optional&lt;SeedlotSeedPlanZoneEntity&gt; sspzOp = sspzList.stream().findFirst();</span>

<span class="pc bpc" id="L615" title="1 of 2 branches missed.">      if (sspzOp.isPresent()) {</span>
<span class="fc" id="L616">        SparLog.info(&quot;Creating Seed Plan Zone dto response&quot;);</span>
<span class="fc" id="L617">        spzDtoList.add(</span>
            new SeedPlanZoneDto(
<span class="fc" id="L619">                spuOp.get().getSeedPlanningUnitId(),</span>
<span class="fc" id="L620">                sspzOp.get().getSeedPlanZoneId(),</span>
<span class="fc" id="L621">                sspzOp.get().getGeneticClass().getGeneticClassCode().charAt(0),</span>
<span class="fc" id="L622">                sspzOp.get().getSeedPlanZoneCode(),</span>
<span class="fc" id="L623">                seedlotOp.get().getVegetationCode(),</span>
<span class="fc" id="L624">                seedlotOp.get().getElevationMin(),</span>
<span class="fc" id="L625">                seedlotOp.get().getElevationMax()));</span>
      } else {
<span class="nc" id="L627">        SparLog.warn(&quot;No Seed plan Zone found for spu id {}&quot;, spuOp.get().getSeedPlanningUnitId());</span>
      }
<span class="fc" id="L629">    }</span>

<span class="pc bpc" id="L631" title="1 of 2 branches missed.">    if (spzDtoList.isEmpty()) {</span>
<span class="nc" id="L632">      SparLog.warn(&quot;ActiveOrchardSpuEntity record not found for any seedlot orchard&quot;);</span>
<span class="nc" id="L633">      throw new SeedlotOrchardNotFoundException();</span>
    }

<span class="fc" id="L636">    return spzDtoList;</span>
  }

  private void setSeedlotSpzInformation(Seedlot seedlot) {
<span class="pc bpc" id="L640" title="1 of 2 branches missed.">    if (!seedlot.getSeedlotSource().getSeedlotSourceCode().equals(&quot;TPT&quot;)) {</span>
<span class="fc" id="L641">      SparLog.warn(</span>
          &quot;Skipping SPZ information for seedlot {}, due the seedlot source code not being tested!&quot;,
<span class="fc" id="L643">          seedlot.getId());</span>
<span class="fc" id="L644">      return;</span>
    }

<span class="nc" id="L647">    List&lt;SeedlotOrchard&gt; seedlotOrchards =</span>
<span class="nc" id="L648">        seedlotOrchardService.getAllSeedlotOrchardBySeedlotNumber(seedlot.getId());</span>

<span class="nc" id="L650">    List&lt;Integer&gt; spuIds = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L651">    Map&lt;String, Integer&gt; orchardIdSpuIdMap = new HashMap&lt;&gt;();</span>

<span class="nc bnc" id="L653" title="All 2 branches missed.">    for (SeedlotOrchard orchard : seedlotOrchards) {</span>
<span class="nc" id="L654">      Optional&lt;ActiveOrchardSpuEntity&gt; spuEntity =</span>
<span class="nc" id="L655">          orchardService.findSpuIdByOrchardWithActive(orchard.getOrchard(), true);</span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">      if (spuEntity.isPresent()) {</span>
<span class="nc" id="L657">        Integer spuId = spuEntity.get().getSeedPlanningUnitId();</span>

<span class="nc" id="L659">        SparLog.info(&quot;Adding SPU id to fetch from Oracle {}&quot;, spuId);</span>
<span class="nc" id="L660">        spuIds.add(spuId);</span>
<span class="nc" id="L661">        orchardIdSpuIdMap.put(orchard.getOrchard(), spuId);</span>
<span class="nc" id="L662">      } else {</span>
<span class="nc" id="L663">        SparLog.info(&quot;No SPU id found for orchard&quot;);</span>
      }
<span class="nc" id="L665">    }</span>

<span class="nc" id="L667">    List&lt;SeedPlanZoneDto&gt; seedPlanZoneResp = oracleApiProvider.getSpzInformationBySpuIds(spuIds);</span>

<span class="nc bnc" id="L669" title="All 2 branches missed.">    for (SeedPlanZoneDto spz : seedPlanZoneResp) {</span>
<span class="nc" id="L670">      SeedlotSeedPlanZoneId spzId =</span>
<span class="nc" id="L671">          new SeedlotSeedPlanZoneId(seedlot.getId(), spz.getSeedPlanZoneCode());</span>
<span class="nc" id="L672">      Optional&lt;SeedlotSeedPlanZoneEntity&gt; spzEntityOp =</span>
<span class="nc" id="L673">          seedlotSeedPlanZoneRepository.findById(spzId);</span>

<span class="nc bnc" id="L675" title="All 2 branches missed.">      if (spzEntityOp.isPresent()) {</span>
<span class="nc" id="L676">        seedlotSeedPlanZoneRepository.deleteById(spzId);</span>
<span class="nc" id="L677">        seedlotSeedPlanZoneRepository.flush();</span>
      }

<span class="nc" id="L680">      Optional&lt;GeneticClassEntity&gt; classEntity =</span>
<span class="nc" id="L681">          geneticClassRepository.findById(spz.getGeneticClassCode().toString());</span>

<span class="nc" id="L683">      SeedlotSeedPlanZoneEntity spzEntity =</span>
          new SeedlotSeedPlanZoneEntity(
              seedlot,
<span class="nc" id="L686">              spz.getSeedPlanZoneCode(),</span>
<span class="nc" id="L687">              spz.getSeedPlanZoneId(),</span>
<span class="nc" id="L688">              classEntity.orElseThrow(InvalidSeedlotRequestException::new));</span>
<span class="nc" id="L689">      spzEntity.setAuditInformation(new AuditInformation(loggedUserService.getLoggedUserId()));</span>

<span class="nc" id="L691">      seedlotSeedPlanZoneRepository.saveAndFlush(spzEntity);</span>

<span class="nc" id="L693">      seedlot.setElevationMin(spz.getElevationMin());</span>
<span class="nc" id="L694">      seedlot.setElevationMax(spz.getElevationMax());</span>
<span class="nc" id="L695">    }</span>
<span class="nc" id="L696">  }</span>

  private void setSeedlotStatus(Seedlot seedlot, String newStatus) {
<span class="fc" id="L699">    Optional&lt;SeedlotStatusEntity&gt; sseOptional =</span>
<span class="fc" id="L700">        seedlotStatusService.getValidSeedlotStatus(newStatus);</span>
<span class="pc bpc" id="L701" title="1 of 2 branches missed.">    if (sseOptional.isEmpty()) {</span>
<span class="nc" id="L702">      throw new SeedlotStatusNotFoundException();</span>
    }
<span class="fc" id="L704">    seedlot.setSeedlotStatus(sseOptional.get());</span>
<span class="fc" id="L705">  }</span>

  private void saveSeedlotFormStep3(Seedlot seedlot, SeedlotFormInterimDto formStep3) {
<span class="fc" id="L708">    SparLog.info(</span>
<span class="fc" id="L709">        &quot;Saving Seedlot Form Step 3-Interim Storage for seedlot number {}&quot;, seedlot.getId());</span>

<span class="fc" id="L711">    seedlot.setInterimStorageClientNumber(formStep3.intermStrgClientNumber());</span>
<span class="fc" id="L712">    seedlot.setInterimStorageLocationCode(formStep3.intermStrgLocnCode());</span>
<span class="fc" id="L713">    seedlot.setInterimStorageStartDate(formStep3.intermStrgStDate());</span>
<span class="fc" id="L714">    seedlot.setInterimStorageEndDate(formStep3.intermStrgEndDate());</span>
<span class="fc" id="L715">    seedlot.setInterimStorageFacilityCode(formStep3.intermFacilityCode());</span>
    // If the facility type is Other, then a description is required.
<span class="fc" id="L717">    SparLog.info(&quot;{} FACILITY TYPE CODE&quot;, formStep3.intermFacilityCode());</span>
<span class="fc" id="L718">    SparLog.info(&quot;FACILITY TYPE Desc&quot;, formStep3.intermOtherFacilityDesc());</span>
<span class="fc bfc" id="L719" title="All 2 branches covered.">    if (formStep3.intermFacilityCode().equals(&quot;OTH&quot;)) {</span>
<span class="fc" id="L720">      SparLog.info(&quot;equal to OTH&quot;);</span>
<span class="fc bfc" id="L721" title="All 2 branches covered.">      if (formStep3.intermOtherFacilityDesc() == null</span>
<span class="pc bpc" id="L722" title="1 of 2 branches missed.">          || formStep3.intermOtherFacilityDesc().isEmpty()) {</span>
<span class="fc" id="L723">        throw new SeedlotFormValidationException(</span>
            &quot;Invalid interim step data: Storage facility type description is needed for facility&quot;
                + &quot; type 'Other'. &quot;);
      }
<span class="nc" id="L727">      seedlot.setInterimStorageOtherFacilityDesc(formStep3.intermOtherFacilityDesc());</span>
    }
<span class="fc" id="L729">  }</span>

  private void saveSeedlotFormStep5(
      Seedlot seedlot,
      List&lt;SeedlotFormParentTreeSmpDto&gt; seedlotFormParentTreeDtoList,
      List&lt;SeedlotFormParentTreeSmpDto&gt; seedlotFormParentTreeSmpDtoList) {
<span class="fc" id="L735">    SparLog.info(</span>
<span class="fc" id="L736">        &quot;Saving Seedlot Form Step 5-Parent Tree SMP Mix for seedlot number {}&quot;, seedlot.getId());</span>

<span class="fc" id="L738">    seedlotParentTreeService.saveSeedlotFormStep5(seedlot, seedlotFormParentTreeDtoList);</span>
<span class="fc" id="L739">    seedlotParentTreeGeneticQualityService.saveSeedlotFormStep5(</span>
        seedlot, seedlotFormParentTreeDtoList);
<span class="fc" id="L741">    seedlotGeneticWorthService.saveSeedlotFormStep5(seedlot, seedlotFormParentTreeDtoList);</span>

    // SMP Mix information is optional, so the array may be empty,
    // in this case there is no need to save the list
<span class="pc bpc" id="L745" title="1 of 2 branches missed.">    if (!seedlotFormParentTreeSmpDtoList.isEmpty()) {</span>
<span class="fc" id="L746">      smpMixService.saveSeedlotFormStep5(seedlot, seedlotFormParentTreeSmpDtoList);</span>
<span class="fc" id="L747">      smpMixGeneticQualityService.saveSeedlotFormStep5(seedlot, seedlotFormParentTreeSmpDtoList);</span>
<span class="fc" id="L748">      seedlotParentTreeSmpMixService.saveSeedlotFormStep5(seedlot, seedlotFormParentTreeSmpDtoList);</span>
    } else {
<span class="nc" id="L750">      SparLog.info(&quot;No SmpMix data for seedlot number {}&quot;, seedlot.getId());</span>
    }
<span class="fc" id="L752">  }</span>

  private void saveSeedlotFormStep6(Seedlot seedlot, SeedlotFormExtractionDto formStep6) {
<span class="fc" id="L755">    SparLog.info(</span>
<span class="fc" id="L756">        &quot;Saving Seedlot Form Step 6-Extraction Storage for seedlot number {}&quot;, seedlot.getId());</span>

<span class="fc" id="L758">    seedlot.setExtractionClientNumber(formStep6.extractoryClientNumber());</span>
<span class="fc" id="L759">    seedlot.setExtractionLocationCode(formStep6.extractoryLocnCode());</span>
<span class="fc" id="L760">    seedlot.setExtractionStartDate(formStep6.extractionStDate());</span>
<span class="fc" id="L761">    seedlot.setExtractionEndDate(formStep6.extractionEndDate());</span>

<span class="fc" id="L763">    seedlot.setStorageClientNumber(formStep6.storageClientNumber());</span>
<span class="fc" id="L764">    seedlot.setStorageLocationCode(formStep6.storageLocnCode());</span>
<span class="fc" id="L765">    seedlot.setTemporaryStorageStartDate(formStep6.temporaryStrgStartDate());</span>
<span class="fc" id="L766">    seedlot.setTemporaryStorageEndDate(formStep6.temporaryStrgEndDate());</span>
<span class="fc" id="L767">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>