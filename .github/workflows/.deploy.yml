name: .Deploys

on:
  workflow_call:
    inputs:
      ### Required
      # Nothing! Only `secrets: inherit` is required

      ### Typical / recommended
      environment:
        description: GitHub/OpenShift environment; usually PR number, test or prod
        default: ''
        type: string
      tag:
        description: Container tag; usually PR number
        default: ${{ github.event.number }}
        type: string
      target:
        description: Deployment target; usually PR number, test or prod
        default: ${{ github.event.number }}
        type: string
      triggers:
        description: List of directories to trigger the deployment
        default: ''
        type: string

      ### Optional / per-environment
      db-pvc-size:
        description: Database PVC size; e.g. 1Gi
        default: "1.8Gi"
        type: string
      db-memory-request:
        description: Database memory request; e.g. 2Gi
        default: "2Gi"
        type: string
      max-replicas:
        description: Maximum replicas for backend, frontend and oracle-api
        default: 5
        type: number
      min-replicas:
        description: Minimum replicas for backend, frontend and oracle-api
        default: 3
        type: number

    outputs:
      triggered:
        description: Has a deployment been triggered?
        value: ${{ jobs.init.outputs.triggered }}

permissions: {}

jobs:
  init:
    name: Deploy (init)
    environment: ${{ inputs.environment }}
    outputs:
      fam-modded-zone: ${{ steps.fam-modded-zone.outputs.fam-modded-zone }}
      triggered: ${{ steps.trigger.outputs.triggered }}
    runs-on: ubuntu-24.04
    steps:
      - name: FAM routing
        id: fam-modded-zone
        run: |
          if [ ${{ github.event_name }} == 'pull_request' ]; then
            echo "fam-modded-zone=$(( ${{ inputs.target }} % 50 ))" >> $GITHUB_OUTPUT
          else
            echo "fam-modded-zone=${{ inputs.target }}" >> $GITHUB_OUTPUT
          fi

      - name: OpenShift Init
        id: trigger
        uses: bcgov/action-deployer-openshift@v3.1.0
        with:
          oc_namespace: ${{ vars.OC_NAMESPACE }}
          oc_server: ${{ vars.OC_SERVER }}
          oc_token: ${{ secrets.OC_TOKEN }}
          file: common/openshift.init.yml
          overwrite: true
          parameters:
            -p ZONE=${{ inputs.target }}
            -p DB_PASSWORD='${{ secrets.DB_PASSWORD }}'
            -p FORESTCLIENTAPI_KEY='${{ secrets.FORESTCLIENTAPI_KEY }}'
            -p ORACLE_PASSWORD='${{ secrets.ORACLE_PASSWORD }}'
            -p ORACLE_SERVICE='${{ vars.ORACLE_SERVICE }}'
            -p ORACLE_USER='${{ vars.ORACLE_USER }}'
            -p ORACLE_CERT_SECRET='${{ secrets.ORACLE_CERT_SECRET }}'
            -p ORACLE_HOST='${{ vars.ORACLE_HOST }}'
            -p VITE_USER_POOLS_WEB_CLIENT_ID=${{ secrets.VITE_USER_POOLS_WEB_CLIENT_ID }}
          triggers: ${{ inputs.triggers }}

      - name: Database
        uses: bcgov/action-deployer-openshift@v3.1.0
        with:
          oc_namespace: ${{ vars.OC_NAMESPACE }}
          oc_server: ${{ vars.OC_SERVER }}
          oc_token: ${{ secrets.OC_TOKEN }}
          file: common/openshift.database.yml
          overwrite: false
          parameters:
            -p ZONE=${{ inputs.target }}
            -p DB_PVC_SIZE=${{ inputs.db-pvc-size }}
            -p MEMORY_REQUEST=${{ inputs.db-memory-request }}
          triggers: ${{ inputs.triggers }}

  deploy:
    name: Deploy
    environment: ${{ inputs.environment }}
    needs: [init]
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    strategy:
      matrix:
        name: [backend, frontend, oracle-api]
        include:
          - name: backend
            parameters:
              -p AWS_COGNITO_ISSUER_URI=https://cognito-idp.ca-central-1.amazonaws.com/${{ vars.VITE_USER_POOLS_ID }}
            verification_path: "health"
          - name: frontend
            parameters:
              -p FAM_MODDED_ZONE=${{ needs.init.outputs.fam-modded-zone }}
              -p VITE_SPAR_BUILD_VERSION=snapshot-${{ inputs.target }}
              -p VITE_USER_POOLS_ID=${{ vars.VITE_USER_POOLS_ID }}
          - name: oracle-api
            parameters:
              -p AWS_COGNITO_ISSUER_URI=https://cognito-idp.ca-central-1.amazonaws.com/${{ vars.VITE_USER_POOLS_ID }}
            verification_path: "actuator/health"
    steps:
      - uses: bcgov/action-deployer-openshift@v3.2.0
        id: deploys
        with:
          file: ${{ matrix.name }}/openshift.deploy.yml
          oc_namespace: ${{ vars.OC_NAMESPACE }}
          oc_server: ${{ vars.OC_SERVER }}
          oc_token: ${{ secrets.OC_TOKEN }}
          parameters:
            -p TAG=${{ inputs.tag }}
            -p ZONE=${{ inputs.target }}
            -p MIN_REPLICAS=${{ inputs.min-replicas }}
            -p MAX_REPLICAS=${{ inputs.max-replicas }}
            ${{ matrix.parameters }}
          triggers: ${{ inputs.triggers }}
          verification_path: ${{ matrix.verification_path }}
          verification_retry_attempts: 5
          verification_retry_seconds: 20
