name: Merge

on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
      - '.github/**'
      - '.github/graphics/**'
      - '!.github/workflows/**'

concurrency:
  # Do not interrupt previous workflows
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  init:
    name: Initialize
    outputs:
      pr: ${{ steps.pr.outputs.pr }}
    runs-on: ubuntu-latest
    steps:
        # Get PR number for squash merges to main
      - name: PR Number
        id: pr
        uses: bcgov-nr/action-get-pr@v0.0.1

  deploys:
    name: TEST
    needs: [init]
    secrets: inherit
    uses: ./.github/workflows/.deploy.yml
    with:
      environment: test
      tag: ${{ needs.init.outputs.pr }}
      target: test

  # deploy-prod:
  #   name: PROD
  #   needs: [init, deploys]
  #   secrets: inherit
  #   uses: ./.github/workflows/.deploy.yml
  #   with:
  #     environment: prod
  #     tag: ${{ needs.init.outputs.pr }}
  #     target: prod
